<!DOCTYPE html>
<html>
<head>
<script src="lib/jquery-1.7.1.min.js" type="text/javascript"></script>
<script type="text/javascript" src="lib/jquery-ui-1.8.16.custom.min.js"></script>
<script type="text/javascript" src="../../js/query.js"></script>
<script type="text/javascript" src="lib/jquery.flot.min.js"></script>
<script type="text/javascript" src="lib/jquery.flot.stack.min.js"></script>
<script type="text/javascript" src="lib/jquery.flot.orderBars.js"></script>
<script src="lib/jquery.mousewheel.min.js"></script>

<script type="text/javascript" src="../autocomplete/lib/jquery.ui.autocomplete.html.js"></script>
<script type="text/javascript" src="../autocomplete/lib/jquery.ui.autocomplete.toggle.js"></script>
<script type="text/javascript" src="../autocomplete/lib/Math.uuid.js"></script>
<script type="text/javascript" src="../autocomplete/lib/jquery.caret.1.02.js"></script>
<script type="text/javascript" src="../../js/autocomplete.js"></script>

<script src="lib/jQRangeSlider-modified.js"></script>

<script type="text/javascript" src="../../js/config.js"></script>

<link rel="icon" type="image/x-icon" href="/favicon.ico"/>
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />

<link rel="stylesheet" href="lib/range-css/dev.css"> 
<link type="text/css" href="lib/smoothness/jquery-ui-1.8.16.custom.css" rel="stylesheet" />	
<link type="text/css" rel="stylesheet" href="lib/reset.css" />
<link type="text/css" rel="stylesheet" href="lib/text.css" />
<link type="text/css" rel="stylesheet" href="lib/960.css" />
<link type="text/css" rel="stylesheet" href="448b.css" />
<title>Newspaper Explorer</title>
</head>
		<style type="text/css">
            .term-completes ul {
                -webkit-column-count: 4; -webkit-column-gap:0px;
                -moz-column-count:4; -moz-column-gap:0px;
                -o-column-count:4; -o-column-gap:0px;
                column-count:4; column-gap:0px;
            }
            /*float breaks multi-column on firefox*/
            .term-completes .ui-menu-item {
                float:none;
            }
            /*fixes sizing issues*/
            .term-completes #ui-active-menuitem {
                border:none;
                margin:0px;
            }
            .term-completes .ui-autocomplete {
                min-width:660px;
                font-size:75%;
            }
            .query {
                min-width:660px;
            }
            #query_holder>div:nth-of-type(1) .query {
                background-color:#f8e7b3;
            }
            #query_holder>div:nth-of-type(2) .query {
                background-color:#d3e9fb;
            }
            #query_holder>div:nth-of-type(3) .query {
                background-color:#f25a5a;
            }
            #query_holder>div:nth-of-type(4) .query {
                background-color:#9dcf9d;
            }
            #query_holder>div:nth-of-type(5) .query {
                background-color:#d4b3f8;
            }
            #query_holder>div:nth-of-type(6) .query {
                background-color:#bd9b35;
            }
            #query_holder>div:nth-of-type(7) .query {
                background-color:#8cabc6;
            }
            #query_holder>div:nth-of-type(8) .query {
                background-color:#dab1b1;
            }
           
		</style>	

</head>
<body>
<div class="container_16">
<h1 style="margin-bottom:3px">Newspaper Explorer
<span style="font-size:33%;">Showing the number of newspaper articles matching your query.</span>
<div style="float:right;display:none" id="loading">
    <img src="../d3-based/statics/images/roller.gif" id="js_sparkline_roller" class="js_roller" />            		
</div>

</h1>
  <div id="query_holder"></div>
  <div class="grid_12" id="plot" style="height:400px;">&nbsp;</div>
  <div class="clear"></div>

  <div class="grid_12" style="padding-top:30px">
	  <div id="daterange">
	  </div>
  </div>
  <div class="clear"></div>
  <div class="grid_14" id="settings">
	  <fieldset><legend>Chart style</legend><div id="graphType"><span class="graphOption selected" id="bars">Bars</span> <span class="graphOption" id="lines">Lines</span> <span class="graphOption" id="areas">Area</span></div></fieldset>
	  <fieldset><legend>Horizontal axis</legend><div id="graphAxis"><span class="graphOption" id="week">Week</span><span class="graphOption selected" id="month">Months</span> <span class="graphOption" id="year">Years</span>  <span class="graphOption" id="page">Pages</span><span class="graphOption" id="dayofweek">Day</span></div></fieldset>
	  <fieldset><legend>Other options</legend><span class="graphOption" id="stacked">Stacked</span><span class="graphOption" id="countmode"><span class="hidewhenon">For Each</span><span class="hidewhenoff">Once</span></span></fieldset>
  </div>
  <div class="clear"></div>
  <div class="grid_16">
  <strong>Interesting graphs:</strong>
  <div id="interesting">
  <ul>
    <li><a href="#%7B%22graph%22%3A%7B%22series%22%3A%5B%5D%2C%22horizontalAxis%22%3A%22month%22%2C%22graphStack%22%3Afalse%2C%22graphCountMode%22%3Atrue%2C%22graphMode%22%3A%22lines%22%2C%22startYear%22%3A2000%2C%22endYear%22%3A2010%7D%2C%22expr%22%3A%5B%22(section%3Aopinion%2Csection%3Aeditorial)%2Bhealthcare%2Bsentiment%3Apos%22%2C%22(section%3Aopinion%2Csection%3Aeditorial)%2Bhealthcare%2Bsentiment%3Aneg%22%5D%7D">positive and negative sentiment in editorials about healthcare</a>
    <li><a href="#%7B%22graph%22%3A%7B%22series%22%3A%5B%5D%2C%22horizontalAxis%22%3A%22month%22%2C%22graphStack%22%3Afalse%2C%22graphCountMode%22%3Afalse%2C%22graphMode%22%3A%22lines%22%2C%22startYear%22%3A2000%2C%22endYear%22%3A2010%7D%2C%22expr%22%3A%5B%22title%3Awar%22%2C%22title%3Apeace%22%2C%22war%22%2C%22peace%22%5D%7D">war and peace in titles and full text</a>
    <li><a href="#%7B%22graph%22%3A%7B%22series%22%3A%5B%5D%2C%22horizontalAxis%22%3A%22month%22%2C%22graphStack%22%3Afalse%2C%22graphCountMode%22%3Afalse%2C%22graphMode%22%3A%22lines%22%2C%22startYear%22%3A2000%2C%22endYear%22%3A2010%7D%2C%22expr%22%3A%5B%22recession%2Bsection%3Abusiness%22%2C%22(depression%2Cgreat%20depression)%2Bsection%3Abusiness%22%2C%22bailout%22%5D%7D">recession, depression, bailout in the business section</a>
    <li><a href="#%7B%22graph%22%3A%7B%22series%22%3A%5B%5D%2C%22horizontalAxis%22%3A%22month%22%2C%22graphStack%22%3Afalse%2C%22graphCountMode%22%3Afalse%2C%22graphMode%22%3A%22lines%22%2C%22startYear%22%3A2000%2C%22endYear%22%3A2010%7D%2C%22expr%22%3A%5B%22title%3Asex%22%2C%22title%3Adrug%22%2C%22title%3Aviolen%22%5D%7D">sex,drug,violence in titles</a>
    <li><a href="#%7B%22graph%22%3A%7B%22series%22%3A%5B%5D%2C%22horizontalAxis%22%3A%22month%22%2C%22graphStack%22%3Afalse%2C%22graphCountMode%22%3Afalse%2C%22graphMode%22%3A%22lines%22%2C%22startYear%22%3A2000%2C%22endYear%22%3A2010%7D%2C%22expr%22%3A%5B%22sex%22%2C%22drug%22%2C%22(violence%2Cviolent%2Cviolently)%22%5D%7D">sex.drug,violence in full-text</a>
    <li><a href="#%7B%22graph%22%3A%7B%22series%22%3A%5B%5D%2C%22horizontalAxis%22%3A%22month%22%2C%22graphStack%22%3Afalse%2C%22graphCountMode%22%3Afalse%2C%22graphMode%22%3A%22lines%22%2C%22startYear%22%3A2000%2C%22endYear%22%3A2010%7D%2C%22expr%22%3A%5B%22(title%3Asteal%2Ctitle%3Astolen)%22%2C%22(title%3Agift)%22%5D%7D">steal vs gift in titles</a>
    <li><a href="#{%22graph%22%3A{%22series%22%3A[]%2C%22horizontalAxis%22%3A%22month%22%2C%22graphStack%22%3Afalse%2C%22graphCountMode%22%3Afalse%2C%22graphMode%22%3A%22lines%22%2C%22startYear%22%3A2000%2C%22endYear%22%3A2010}%2C%22expr%22%3A[%22%28steal%2Cstealing%2Csteals%2Cstolen%29%22%2C%22%28gift%2Cgifts%29%22]}">steal vs gift in full-text</a>
    <li><a href="#%7B%22graph%22%3A%7B%22series%22%3A%5B%5D%2C%22horizontalAxis%22%3A%22month%22%2C%22graphStack%22%3Afalse%2C%22graphCountMode%22%3Afalse%2C%22graphMode%22%3A%22lines%22%2C%22startYear%22%3A2000%2C%22endYear%22%3A2010%7D%2C%22expr%22%3A%5B%22(steal%2Cstealing%2Csteals%2Cstolen)%2B!section%3Asport%22%2C%22(gift%2Cgifts)%2B!(holiday%2Cchristmas)%22%5D%7D">steal vs gift in full-text, excluding sports and christmas</a>
    <li><a href="#%7B%22graph%22%3A%7B%22series%22%3A%5B%5D%2C%22horizontalAxis%22%3A%22month%22%2C%22graphStack%22%3Atrue%2C%22graphCountMode%22%3Afalse%2C%22graphMode%22%3A%22areas%22%2C%22startYear%22%3A2000%2C%22endYear%22%3A2010%7D%2C%22expr%22%3A%5B%22(google%2Cgoogle%20inc.)%22%2C%22(facebook%2Cfacebook%20inc.)%22%2C%22(microsoft%2Cmicrosoft%20corp.%2Cmicrosoft%20co)%22%2C%22(twitter.com%2Ctwitter%20inc.%2Ctwitter)%22%2C%22(apple%20computer%20inc.%2Capple%20inc.)%22%5D%7D">tech giants</a>
    <li><a href="#%7B%22graph%22%3A%7B%22series%22%3A%5B%5D%2C%22horizontalAxis%22%3A%22month%22%2C%22graphStack%22%3Afalse%2C%22graphCountMode%22%3Afalse%2C%22graphMode%22%3A%22lines%22%2C%22startYear%22%3A2000%2C%22endYear%22%3A2010%7D%2C%22expr%22%3A%5B%22(blockbuster%20inc.%2Cblockbuster%20video%2Cblockbuster.com)%22%2C%22(netflix%2Cnetflix%20inc.%2Cnetflix.com)%22%5D%7D">netflix v. blockbuster</a>
    <li><a href="#%7B%22graph%22%3A%7B%22series%22%3A%5B%5D%2C%22horizontalAxis%22%3A%22month%22%2C%22graphStack%22%3Afalse%2C%22graphCountMode%22%3Atrue%2C%22graphMode%22%3A%22lines%22%2C%22startYear%22%3A2000%2C%22endYear%22%3A2010%7D%2C%22expr%22%3A%5B%22india%22%2C%22pakistan%22%2C%22india%2Bpakistan%22%5D%7D">india v. pakistan</a>
    <li><a href="#%7B%22graph%22%3A%7B%22series%22%3A%5B%5D%2C%22horizontalAxis%22%3A%22year%22%2C%22graphStack%22%3Afalse%2C%22graphCountMode%22%3Atrue%2C%22graphMode%22%3A%22lines%22%2C%22startYear%22%3A2000%2C%22endYear%22%3A2010%7D%2C%22expr%22%3A%5B%22(internet%20explorer%2Cmicrosoft%20internet%20explorer)%22%2C%22(google%20chrome%2Cgoogle%20chrome%20os%2Cgoogle%20chrome%20technology%2C((google%2Cgoogle%20inc.)%2Bchrome))%22%2C%22(mozilla%20firefox%2Cfirefox)%22%2C%22safari%2Bapple%22%5D%7D">web browsers</a>
    <li><a href="#%7B%22graph%22%3A%7B%22series%22%3A%5B%5D%2C%22horizontalAxis%22%3A%22month%22%2C%22graphStack%22%3Afalse%2C%22graphCountMode%22%3Atrue%2C%22graphMode%22%3A%22lines%22%2C%22startYear%22%3A2000%2C%22endYear%22%3A2010%7D%2C%22expr%22%3A%5B%22california%22%2C%22texas%22%5D%7D">california v texas</a>
    <li><a href="#%7B%22graph%22%3A%7B%22series%22%3A%5B%5D%2C%22horizontalAxis%22%3A%22dayofweek%22%2C%22graphStack%22%3Afalse%2C%22graphCountMode%22%3Atrue%2C%22graphMode%22%3A%22bars%22%2C%22startYear%22%3A2000%2C%22endYear%22%3A2010%7D%2C%22expr%22%3A%5B%22sentiment%3Apos%2Byear%3A2000%22%2C%22sentiment%3Aneg%2Byear%3A2000%22%2C%22sentiment%3Apos%2Byear%3A2010%22%2C%22sentiment%3Aneg%2Byear%3A2010%22%5D%7D">positive v negative sentiment by day of week for 2010 and 2000</a>
    <li><a href="#%7B%22graph%22%3A%7B%22series%22%3A%5B%5D%2C%22horizontalAxis%22%3A%22page%22%2C%22graphStack%22%3Afalse%2C%22graphCountMode%22%3Atrue%2C%22graphMode%22%3A%22bars%22%2C%22startYear%22%3A2000%2C%22endYear%22%3A2010%7D%2C%22expr%22%3A%5B%22sentiment%3Apos%22%2C%22sentiment%3Aneg%22%5D%7D">positive v negative sentiment by page number</a>
    </ul>
  </div>

</div>


<div id="inspector_dialog" title="Headline Inspector">
</div>


<!--- TEMPLATES --->
<div id="templates">

	<div id="series_template" class="series">
		<div class="sGrip">||</div>
		<div class="contents"></div>
	</div>

	<div id="disjunction_template" class="disjunction">
		(
		<div class="dGrip">||</div>
		<div class="contents"></div>
		)
	</div>
    
    <div id="query_template">
      <div class="grid-autocomplete ui-widget">
        <span>Query:</span><input type="text" class="query"><button class="series-remove">Remove</button><button class="series-add">Add</button>
        <div class="term-completes"></div>
      </div>
    </div>

	
	<div id="literal_template" class="literal">
	<span></span>
	</div>
</div>
<!--- /TEMPLATES --->
<script type="text/javascript" src="448b.js"></script>
<script>
function queryForTextArray(state, text) {
	var query = {};
	var AndHelper = function(arr) { return arr.length > 1 ? {and_:{terms_: arr }} : arr[0]; };
	var OrHelper = function(arr) { return arr.length > 1 ? {or_:{terms_: arr }} : arr[0]; };
	var WordToTerm = LemmaTerm;
	
	WordToTerm = function(a) { return OrTerm(LemmaTerm(a), EntityTerm(a)); };

	
	query.filter_ = {date_:{before_:(state.endYear+1)*10000, after_:(state.startYear*10000 - 1)}};
	
	query.series_ = text
		.map(function(x) {
			return buildExpression(x);
		});
	handleBuckets(query, state);
	return query;
}
function rawQuery() {
    var qs = [];
    var jqs = $("#query_holder .query");
    for(var i = 0; i < jqs.length; ++i) {
        qs.push($(jqs[i]).attr("value"))
    }
    var st = domStateToObject();
    var query = queryForTextArray(st, qs);
    return query;
}

function queryChanged() {
	if(ignoreQueryChange)
		return;
        
    var qs = [];
    var jqs = $("#query_holder .query");
    for(var i = 0; i < jqs.length; ++i) {
        qs.push($(jqs[i]).attr("value"))
    }
    var st = domStateToObject();
    var query = queryForTextArray(st, qs);
	hashIgnore = true;

    try {
        history.replaceState(undefined, 'News Explorer', (window.location +"").split('#')[0] + '#' + encodeURIComponent(JSON.stringify({graph:st,expr:qs})));
    } catch(err) {
        window.location.hash = encodeURIComponent(JSON.stringify({graph:st,expr:qs}));
    }
	hashIgnore = false;

	// will get called anytime the query gets changed in any way
	// we probably want to do some rate-limiting to avoid DoSing the server with queries
    var query = queryForTextArray(st, qs);
    $("#loading").css("display", "block");
    arbitraryQuery(viewModel.graphCountMode() ? "/api/query/winnerdocs/bucketed" :"/api/query/docs/bucketed",    
        query,
        function(gen,query,c,r,d){
            $("#loading").css("display", "none");
            if(!success(c)) {
                //alert("query failed to run: " + r);
                //alert(JSON.stringify(query));
                return;
            }
            if(gen != current_generation)
                return;
            handlePlotData(r);
        }.bind(this, ++current_generation, query)
    );
}
function hashChange() {
	if(hashIgnore)
		return;
	if(window.location.hash != "") {
        var s = JSON.parse(decodeURIComponent(window.location.hash.slice(1)));
		objectToDomState(s.graph);
        $("#query_holder").children().remove();
        for(var i in s.expr) {
            addSeries(s.expr[i], true);
        }
        queryChanged();
    }
}
function seriesCount() {
    var count = $("#query_holder .query").length;
    return count;
}
function removeSeries(qt) {
    if($("#query_holder .query").length == 1) {
        qt.attr("value","");
    } else {
        qt.remove();
    }
    queryChanged();
}

function addSeries(q, wait) {
    var qt = $("#query_template").clone().attr("id", null).appendTo($("#query_holder"));
    var nq = $(".query", qt);
    if(q)
        nq.attr("value", q);
    createAutoComplete(nq, queryChanged);
    var remove = $(".series-remove", qt).button(
        {
            icons: {
                primary: "ui-icon-circle-close"
            },
            text: false
        }
    );
    remove.click(removeSeries.bind(undefined, qt));
    var add = $(".series-add", qt).button(
        {
            icons: {
                primary: "ui-icon-circle-plus"
            },
            text: false
        }
    );
    add.click(addSeries.bind(undefined, undefined, undefined));
    if(!wait)
        queryChanged();
    return nq;
}
hashChange();
window.onhashchange = hashChange;
if(seriesCount() == 0) {
    addSeries();
}
queryChanged();
</script>
</body>
</html>